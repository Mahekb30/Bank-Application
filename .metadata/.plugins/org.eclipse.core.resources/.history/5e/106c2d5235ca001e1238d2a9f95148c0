package com.example.services;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import com.example.dao.CustomerRepository;
import com.example.dtos.CustomerRequestDto;
import com.example.dtos.CustomerResponseDto;
import com.example.dtos.LoanEvent;
import com.example.dtos.LoanRequestDto;
import com.example.dtos.LoanResponseDto;
import com.example.entities.Customer;
import com.example.producer.CustomerProducer;

@Service
public class CustomerService {
    @Autowired
    private CustomerRepository customerRepository;
    
    @Autowired
    private CustomerProducer customerProducer;
    
    @Value("${loan.service.url}")
    private String loanServiceUrl;
    
    final RestTemplate template;
    
    public CustomerService(RestTemplate restTemplate){
      super();
      this.template = restTemplate;
    }
    
    public List<CustomerResponseDto> getAllCustomers(String balance, String name, Long accNo) {
      
        List<Customer> customers =  customerRepository.findAll();
        customers = customers.stream().filter(customer -> 
               (accNo == null || customer.getAccNo().equals(accNo))
            && (name == null || customer.getName().equals(name))
            && (balance == null || checkBalance(customer.getBalance(), balance))
        ).collect(Collectors.toList());

        
        return customers.stream().map(customer -> mapToDto(customer)).toList();
    }

    public CustomerResponseDto getCustomerById(int id) {
        return mapToDto(customerRepository.findById(id).orElse(null));
    }
    
    public LoanResponseDto getLoanByCustomerId(int id) {
      LoanResponseDto loanData = template.getForObject(loanServiceUrl+"/loans/customer/"+id, LoanResponseDto.class);
      return loanData;
    }
    
    public String createCustomerLoan(LoanRequestDto loan) {
      
      LoanEvent loanEvent = new LoanEvent();
      
      loanEvent.setMessage("Loan is in Pending state");
      loanEvent.setStatus("PENDING");
      loanEvent.setLoan(loan);
      
      customerProducer.sendMessage(loanEvent);
      
      return "Loan Created Successfully";
    }

    public CustomerResponseDto createCustomer(CustomerRequestDto customer) {
        try {
          Customer customerEntity = mapToEntity(customer);
          return mapToDto(customerRepository.save(customerEntity));
        } catch (Exception e) {
          throw new RuntimeException("Error creating customer: " + e.getMessage());
        }
    }

    public CustomerResponseDto updateCustomer(int id, CustomerRequestDto customer) {
      
        Customer customerEntity = mapToEntity(customer);
        
        if (customerRepository.existsById(id)) {
            customerEntity.setId(id);
            return mapToDto(customerRepository.save(customerEntity));
        }
        return null; // Handle not found scenario
    }

    public void deleteCustomer(int id) {
        customerRepository.deleteById(id);
    }
    
    private boolean checkBalance(Double customerBalance, String balance) {
      if (balance.charAt(0) == '>') {
          double threshold = Double.parseDouble(balance.substring(1));
          return customerBalance >= threshold;
      } else if (balance.charAt(0) == '<') {
          double threshold = Double.parseDouble(balance.substring(1));
          return customerBalance <= threshold;
      } else {
          return false;
      }
    }
    
    private Customer mapToEntity(CustomerRequestDto customerRequest) {
      
      if(customerRequest == null) return null;
      
      Customer customer = new Customer();
      customer.setName(customerRequest.getName());
      customer.setAccNo(customerRequest.getAccNo());
      customer.setAccType(customerRequest.getAccType());
      customer.setBalance(customerRequest.getBalance());
      customer.setPanCardNo(customerRequest.getPanCardNo());
      return customer;
     
    }
    
    private CustomerResponseDto mapToDto(Customer customer) {
      
      if(customer == null) return null;
      
      CustomerResponseDto customerResponse = new CustomerResponseDto();
      customerResponse.setId(customer.getId());
      customerResponse.setName(customer.getName());
      customerResponse.setAccNo(customer.getAccNo());
      customerResponse.setAccType(customer.getAccType());
      customerResponse.setBalance(customer.getBalance());
      customerResponse.setPanCardNo(customer.getPanCardNo());
      return customerResponse;
     
    }

}
