package com.example.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.example.entities.Loan;
import com.example.repository.LoanRepository;

@Service
public class LoanService {

    private final LoanRepository loanRepository;

    @Autowired
    public LoanService(LoanRepository loanRepository) {
        this.loanRepository = loanRepository;
    }

    public List<LoanResponseDto> getAllLoans(Double amount, Double interestRate, Integer termMonths, String status) {
        List<Loan> loans = loanRepository.findAll();
        return loans.stream()
                .filter(loan ->
                        (amount == null || loan.getAmount().equals(amount))
                        && (interestRate == null || loan.getInterestRate().equals(interestRate))
                        && (termMonths == null || loan.getTermMonths().equals(termMonths))
                        && (status == null || loan.getStatus().equals(status))
                )
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    public LoanResponseDto getLoanById(Long id) {
        return mapToDto(loanRepository.findById(id).orElse(null));
    }

    public LoanResponseDto createLoan(LoanRequestDto loanRequest) {
        try {
            Loan loanEntity = mapToEntity(loanRequest);
            return mapToDto(loanRepository.save(loanEntity));
        } catch (Exception e) {
            throw new RuntimeException("Error creating loan: " + e.getMessage());
        }
    }

    public LoanResponseDto updateLoan(Long id, LoanRequestDto loanRequest) {
        Loan loanEntity = mapToEntity(loanRequest);
        loanEntity.setId(id);
        return mapToDto(loanRepository.save(loanEntity));
    }

    public void deleteLoan(Long id) {
        loanRepository.deleteById(id);
    }

    private Loan mapToEntity(LoanRequestDto loanRequest) {
        if (loanRequest == null) return null;
        Loan loan = new Loan();
        loan.setCustomerId(loanRequest.getCustomerId());
        loan.setAmount(loanRequest.getAmount());
        loan.setInterestRate(loanRequest.getInterestRate());
        loan.setTermMonths(loanRequest.getTermMonths());
        loan.setStatus(loanRequest.getStatus());
        return loan;
    }

    private LoanResponseDto mapToDto(Loan loan) {
        if (loan == null) return null;
        LoanResponseDto loanResponseDto = new LoanResponseDto();
        loanResponseDto.setId(loan.getId());
        loanResponseDto.setCustomerId(loan.getCustomerId());
        loanResponseDto.setAmount(loan.getAmount());
        loanResponseDto.setInterestRate(loan.getInterestRate());
        loanResponseDto.setTermMonths(loan.getTermMonths());
        loanResponseDto.setStatus(loan.getStatus());
        return loanResponseDto;
    }
}

